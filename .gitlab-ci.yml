
stages:
  - build
  - test
  - package
  - deploy
  - release

variables:
  DEPENDENCY_DIR: build/dependency

build_api-gateway:
  stage: build
  image: gradle:latest
  script:
    - cd spring_apps/api-gateway
    - chmod +x gradlew
    - ./gradlew bootJar
  artifacts:
    paths:
      - spring_apps/api-gateway/build/libs/*.jar
    expire_in: 1 day
  only:
    refs:
      - main
    changes:
     - spring_apps/api-gateway/**/*

build_user-service:
  stage: build
  image: gradle:latest
  script:
    - cd spring_apps/user-service
    - chmod +x gradlew
    - ./gradlew bootJar
  artifacts:
    paths:
      - spring_apps/user-service/build/libs/*.jar
    expire_in: 1 day
  only:
    refs:
      - main
    changes:
     - spring_apps/user-service/**/*

build_garage-service:
  stage: build
  image: gradle:latest
  script:
    - cd spring_apps/garage-service
    - chmod +x gradlew
    - ./gradlew bootJar
  artifacts:
    paths:
      - spring_apps/garage-service/build/libs/*.jar
    expire_in: 1 day
  only:
    refs:
      - main
    changes:
     - spring_apps/garage-service/**/*

build_vehicle-service:
  stage: build
  script:
    - cd spring_apps/vehicle-service
    - chmod +x gradlew
    - ./gradlew bootJar
  artifacts:
    paths:
      - spring_apps/vehicle-service/build/libs/*.jar
    expire_in: 1 day
  only:
    refs:
      - main
    changes:
     - spring_apps/vehicle-service/**/*

build_notification-service:
  stage: build
  image: gradle:latest
  script:
    - cd spring_apps/notification-service
    - chmod +x gradlew
    - ./gradlew bootJar
  artifacts:
    paths:
      - spring_apps/notification-service/build/libs/*.jar
    expire_in: 1 day
  only:
    refs:
      - main
    changes:
     - spring_apps/notification-service/**/*

build_recommendation-service:
  stage: build
  image: gradle:latest
  script:
    - cd spring_apps/recommendation-service
    - chmod +x gradlew
    - ./gradlew bootJar
  artifacts:
    paths:
      - spring_apps/recommendation-service/build/libs/*.jar
    expire_in: 1 day
  only:
    refs:
      - main
    changes:
     - spring_apps/recommendation-service/**/*

unpack_api_gateway_jar:
  stage: package
  script:
    - cd /spring_apps/api-gaterway;
    - mkdir -p ./${DEPENDENCY_DIR};
    - cd ./${DEPENDENCY_DIR};
    - jar -xf ../libs/*.jar;
    - cd ../../../..
    - pwd
    #- docker compose build -f docker-compose.yml
  only:
    refs:
      - main
    changes:
     - spring_apps/**/*
     - ./services.Dockerfile
     - ./docker-compose.yml

# dockerize:
#   stage: package
#   script:
#     - tree
#     - for service in api-gateway user-service garage-service vehicle-service notification-service recommendation-service; do  
#         cd;
#         cd ./**/**/**/**/my_car_specialist/spring_apps;
#         mkdir -p ./$service/${DEPENDENCY_DIR};
#         cd ./$service/${DEPENDENCY_DIR};
#         jar -xf ../libs/*.jar;
#       done
#     - cd;
#     - cd ./**/**/**/**/my_car_specialist
#     - docker compose build -f docker-compose.yml
#   only:
#     refs:
#       - main
#     changes:
#      - spring_apps/**/*
#      - ./services.Dockerfile
#      - ./docker-compose.yml
